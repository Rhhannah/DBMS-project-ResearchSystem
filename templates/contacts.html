{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <h3>基础信息管理</h3>
    <div class="text-muted small">共 {{ teachers|length }} 位教师</div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-body d-flex justify-content-start flex-wrap gap-3 align-items-center">

        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
                <i class="bi bi-person-plus"></i> 新增教师
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="bi bi-file-earmark-excel"></i> 批量导入
            </button>
            <button class="btn btn-danger" type="submit" form="teacher_list_form"
                    onclick="return confirm('确定要删除选中的教师吗？这会同时删除相关的任务记录。')">
                <i class="bi bi-trash"></i> 批量删除
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('download_import_template') }}'">
                <i class="bi bi-download"></i> 下载模板
            </button>
        </div>

        <form class="d-flex gap-2 align-items-center" method="GET" action="{{ url_for('contacts') }}">

            <select name="department" class="form-select" style="width: 180px;" onchange="this.form.submit()">
                <option value="">所有院系</option>
                {% for dep in departments %}
                <option value="{{ dep.dep_id }}" {{ 'selected' if selected_dep == dep.dep_id else '' }}>
                    {{ dep.dep_name }}
                </option>
                {% endfor %}
            </select>

            <input type="text" name="search" class="form-control" placeholder="姓名/职工号/邮箱" value="{{ search_query }}">

            <button type="submit" class="btn btn-outline-primary"
        style="writing-mode: horizontal-tb !important; white-space: nowrap;">
                <i class="bi bi-search"></i> 搜索
            </button>

            <button type="button" class="btn btn-outline-secondary"
                    onclick="window.location.href='{{ url_for('contacts') }}'"
                    style="writing-mode: horizontal-tb !important; white-space: nowrap;">
                <i class="bi bi-x-circle"></i> 重置
            </button>
        </form>
    </div>
</div>

<form method="POST" action="{{ url_for('batch_delete_teachers') }}" id="teacher_list_form">
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th><input type="checkbox" id="select_all_teachers" title="全选"></th>
                        <th>职工号</th>
                        <th>姓名</th>
                        <th>院系</th>
                        <th>职称</th>
                        <th>职务</th>
                        <th>邮箱</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in teachers %}
                    <tr>
                        <td><input type="checkbox" name="teacher_ids" value="{{ t.teacher_id }}" class="teacher-checkbox"></td>
                        <td>{{ t.teacher_id }}</td>
                        <td>{{ t.name }}</td>
                        <td>{{ t.department.dep_name if t.department else '未知' }}</td>
                        <td>{{ t.title }}</td>
                        <td>{{ t.position }}</td>
                        <td>{{ t.email }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editTeacherModal"
                                    data-id="{{ t.teacher_id }}"
                                    data-name="{{ t.name }}"
                                    data-sex="{{ t.sex }}"
                                    data-age="{{ t.age }}"
                                    data-dep="{{ t.department.dep_id if t.department else '' }}"
                                    data-title="{{ t.title or '' }}"
                                    data-position="{{ t.position or '' }}"
                                    data-email="{{ t.email }}"
                                    data-tel="{{ t.tel or '' }}">
                                 编辑
                            </button>

                            <a href="{{ url_for('delete_teacher', teacher_id=t.teacher_id) }}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('确定要删除 {{ t.name }} 吗？这将同时删除相关的任务记录。')">删除</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" class="text-center py-4">未找到相关教师信息</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<div class="modal fade" id="addTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" action="{{ url_for('add_teacher') }}" method="POST">
            <div class="modal-header">
                <h5 class="modal-title">新增教师</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2"><label>职工号</label><input type="text" name="teacher_id" class="form-control" required></div>
                <div class="mb-2"><label>姓名</label><input type="text" name="name" class="form-control" required></div>
                <div class="row mb-2">
                    <div class="col"><label>性别</label><select name="sex" class="form-select"><option>男</option><option>女</option></select></div>
                    <div class="col"><label>年龄</label><input type="number" name="age" class="form-control" value="30"></div>
                </div>
                <div class="mb-2"><label>院系</label>
                    <select name="dep_id" class="form-select" required>
                        {% for dep in departments %}
                        <option value="{{ dep.dep_id }}">{{ dep.dep_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row mb-2">
                    <div class="col"><label>职称</label><input type="text" name="title" class="form-control"></div>
                    <div class="col"><label>职务</label><input type="text" name="position" class="form-control"></div>
                </div>
                <div class="mb-2"><label>邮箱</label><input type="email" name="email" class="form-control" required></div>
                <div class="mb-2"><label>电话</label><input type="text" name="tel" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" action="{{ url_for('edit_teacher') }}" method="POST">
            <div class="modal-header">
                <h5 class="modal-title" id="editTeacherModalLabel">编辑教师信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="original_teacher_id" id="edit_original_teacher_id">
                <div class="mb-2">
                    <label>职工号</label>
                    <input type="text" name="teacher_id" id="edit_teacher_id" class="form-control" required>
                </div>

                <input type="hidden" name="original_name" id="edit_original_name">
                <div class="mb-2">
                    <label>姓名</label>
                    <input type="text" name="name" id="edit_name" class="form-control" required>
                </div>

                <div class="row mb-2">
                    <div class="col">
                        <label>性别</label>
                        <select name="sex" id="edit_sex" class="form-select">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <input type="hidden" name="original_age" id="edit_original_age">
                    <div class="col"><label>年龄</label><input type="number" name="age" id="edit_age" class="form-control"></div>
                </div>

                <div class="mb-2">
                    <label>院系</label>
                    <select name="dep_id" id="edit_dep_id" class="form-select" required>
                        {% for dep in departments %}
                        <option value="{{ dep.dep_id }}">{{ dep.dep_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="row mb-2">
                    <div class="col">
                        <label>职称</label>
                        <input type="hidden" name="original_title" id="edit_original_title"> <input type="text" name="title" id="edit_title" class="form-control">
                    </div>
                    <div class="col">
                        <label>职务</label>
                        <input type="hidden" name="original_position" id="edit_original_position"> <input type="text" name="position" id="edit_position" class="form-control">
                    </div>
                </div>

                <input type="hidden" name="original_email" id="edit_original_email"> <div class="mb-2">
                    <label>邮箱</label>
                    <input type="email" name="email" id="edit_email" class="form-control" required>
                </div>

                <input type="hidden" name="original_tel" id="edit_original_tel"> <div class="mb-2">
                    <label>电话</label>
                    <input type="text" name="tel" id="edit_tel" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary">更新信息</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" action="{{ url_for('batch_import_teachers') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h5 class="modal-title">批量导入教师</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    请上传 .xlsx 格式文件，必需包含列：teacher_id, name, email, dep_name。
                </div>
                <input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">开始上传并导入</button>
            </div>
        </form>
    </div>
</div>

<script>
    var editModal = document.getElementById('editTeacherModal');

    editModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;

        // 1. 数据提取
        var id = button.getAttribute('data-id');
        var name = button.getAttribute('data-name');
        var sex = button.getAttribute('data-sex');
        var age = button.getAttribute('data-age');
        var dep = button.getAttribute('data-dep');
        var title = button.getAttribute('data-title');
        var pos = button.getAttribute('data-position');
        var email = button.getAttribute('data-email');
        var tel = button.getAttribute('data-tel');

        // 2. 职工号/Primary Key (特殊处理)
        document.getElementById('edit_original_teacher_id').value = id;
        document.getElementById('edit_teacher_id').placeholder = id; // 设置 placeholder
        document.getElementById('edit_teacher_id').value = id;      // 保持 value 填充，避免用户忘记输入ID

        // 3. 非下拉菜单字段：设置隐藏 value

        // 姓名
        document.getElementById('edit_original_name').value = name;
        document.getElementById('edit_name').value = name;

        // 年龄
        document.getElementById('edit_original_age').value = age;
        document.getElementById('edit_age').value = age;

        // 邮箱
        document.getElementById('edit_original_email').value = email;
        document.getElementById('edit_email').value= email;

        // 职称
        document.getElementById('edit_original_title').value = title;
        document.getElementById('edit_title').value = title;

        // 职务
        document.getElementById('edit_original_position').value = pos;
        document.getElementById('edit_position').value = pos;

        // 电话
        document.getElementById('edit_original_tel').value = tel;
        document.getElementById('edit_tel').value = tel;

        // 4. 下拉菜单字段 (SELECT)：必须设置 value，因为 placeholder 无效
        document.getElementById('edit_sex').value = sex;
        document.getElementById('edit_dep_id').value = dep;
        // 同样增加隐藏字段用于保障
        document.getElementById('edit_original_sex').value = sex;
        document.getElementById('edit_original_dep_id').value = dep;
    });

    // 批量删除
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('select_all_teachers');
        const checkboxes = document.querySelectorAll('.teacher-checkbox');

        // 监听全选框
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
            });
        }

        // 监听单个复选框，如果任何一个被取消选中，则取消全选框
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked) {
                    if (selectAll) {
                        selectAll.checked = false;
                    }
                } else {
                    // 检查是否所有都被选中，如果是，则选中全选框
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    if (allChecked && selectAll) {
                        selectAll.checked = true;
                    }
                }
            });
        });
    });
</script>
{% endblock %}

