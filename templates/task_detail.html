{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>任务详情：{{ task.task_name }}</h3>
    <a href="{{ url_for('task_center') }}" class="btn btn-outline-secondary">返回列表</a>
</div>

<div class="card mb-4 bg-light">
    <div class="card-body">
        <div class="row text-center">
            {% set total = recipients|length %}
            {% set replied = recipients|selectattr('is_replied', 'equalto', true)|list|length %}
            {% set not_replied = total - replied %}
            {% set rate = (replied / total * 100)|round(1) if total > 0 else 0 %}

            <div class="col-md-3"><h5>总需回收</h5><h2 class="text-primary">{{ total }}</h2></div>
            <div class="col-md-3"><h5>已回复</h5><h2 class="text-success">{{ replied }}</h2></div>
            <div class="col-md-3"><h5>未回复</h5><h2 class="text-danger">{{ not_replied }}</h2></div>
            <div class="col-md-3"><h5>回收率</h5><h2 class="text-info">{{ rate }}%</h2></div>
        </div>
        <div class="progress mt-3" style="height: 20px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ rate }}%">{{ rate }}%</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="detailTabs">
                    <li class="nav-item">
                        <a class="nav-link active text-danger" data-bs-toggle="tab" href="#not-replied">未回复名单 ({{ not_replied }})</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-success" data-bs-toggle="tab" href="#replied">已回复名单 ({{ replied }})</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="not-replied">
                        <form id="remindForm">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                        <th>姓名</th>
                                        <th>院系</th>
                                        <th>上次提醒</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in recipients if not r.is_replied %}
                                    <tr>
                                        <td><input type="checkbox" name="teacher_ids" value="{{ r.teacher.teacher_id }}" class="remind-check"></td>
                                        <td>{{ r.teacher.name }}</td>
                                        <td>{{ r.teacher.department.dep_name }}</td>
                                        <td>{{ r.sent_time.strftime('%m-%d %H:%M') if r.sent_time else '从未' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="replied">
                        <table class="table table-hover">
                            <thead><tr><th>姓名</th><th>院系</th><th>回复时间</th><th>附件</th></tr></thead>
                            <tbody>
                                {% for r in recipients if r.is_replied %}
                                <tr>
                                    <td>{{ r.teacher.name }}</td>
                                    <td>{{ r.teacher.department.dep_name }}</td>
                                    <td>{{ r.sent_time.strftime('%m-%d') }} (模拟)</td> <td><i class="bi bi-file-earmark-excel text-success"></i> 已提交</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-warning h-100">
            <div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-bell-fill"></i> 发送催促提醒</div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <label class="form-label">邮件主题</label>
                    <input type="text" class="form-control" value="【温馨提醒】请尽快提交{{ task.task_name }}">
                </div>
                <div class="mb-3 flex-grow-1">
                    <label class="form-label">提醒正文</label>
                    <textarea class="form-control" style="height: 150px;">各位老师好，{{ task.task_name }}即将截止（{{ task.end_time.strftime('%Y-%m-%d') }}），请尽快查收之前的邮件并回复附件。谢谢！</textarea>
                </div>
                <button class="btn btn-warning w-100 mt-auto" onclick="alert('提醒邮件发送功能（需连接后端逻辑）')">
                    <i class="bi bi-send"></i> 发送给选中的老师
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSelectAll() {
        const checked = document.getElementById('selectAll').checked;
        document.querySelectorAll('.remind-check').forEach(cb => cb.checked = checked);
    }
</script>
{% endblock %}